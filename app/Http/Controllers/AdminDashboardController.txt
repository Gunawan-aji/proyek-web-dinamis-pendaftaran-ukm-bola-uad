<?php

namespace App\Http\Controllers;

use App\Models\Pendaftar; // Pastikan Model Pendaftar diimport
use Illuminate\Http\Request;

class AdminDashboardController extends Controller
{
    public function index(Request $request)
    {
        // Ambil parameter halaman dari URL (default ke 'dashboard')
        $page = $request->query('page', 'dashboard');

        // Statistik Real-time
        $stats = [
            'total'    => Pendaftar::count(),
            'diterima' => Pendaftar::where('status_pendaftaran', 'diterima')->count(),
            'dinilai'  => Pendaftar::whereIn('status_pendaftaran', ['lolos_admin', 'proses_seleksi'])->count(),
            'menunggu' => Pendaftar::where('status_pendaftaran', 'menunggu_verifikasi')->count(),
        ];

        // Persentase (untuk tampilan di bawah angka)
        $percentages = [
            'diterima' => $stats['total'] > 0 ? round(($stats['diterima'] / $stats['total']) * 100, 1) : 0,
            'dinilai'  => $stats['total'] > 0 ? round(($stats['dinilai'] / $stats['total']) * 100, 1) : 0,
            'menunggu' => $stats['total'] > 0 ? round(($stats['menunggu'] / $stats['total']) * 100, 1) : 0,
        ];

        // Ambil 5 pendaftar terbaru untuk tabel di dashboard
        $pendaftarTerbaru = Pendaftar::latest()->take(5)->get();

        // Data untuk halaman spesifik (jika navigasi diklik)
        $dataKonten = [];
        if ($page == 'daftar_peserta') {
            $dataKonten = Pendaftar::paginate(10);
        }

        return view('admin.dashboard', compact('page', 'stats', 'percentages', 'pendaftarTerbaru', 'dataKonten'));

        // 1. Hitung Rata-rata Usia Peserta secara Real-time
    // Mengambil selisih tahun dari kolom tgl_lahir ke tahun sekarang
    $rataRataUsia = \App\Models\Pendaftar::whereNotNull('tgl_lahir')
        ->selectRaw('AVG(TIMESTAMPDIFF(YEAR, tgl_lahir, CURDATE())) as rata_usia')
        ->first()->rata_usia;

    // 2. Ambil Informasi Seleksi (Asumsi Anda punya model/tabel Pengaturan)
    // Jika belum ada tabelnya, Anda bisa hardcode sementara atau membuat model baru
    $infoSeleksi = [
        'lokasi' => 'Stadion Gajah Mada', // Bisa diambil dari DB: Pengaturan::first()->lokasi
        'jadwal' => '20 November 2025, 14:30 - 18:00 WIB',
        'kelulusan' => $percentages['diterima'] ?? 0 // Diambil dari % diterima yang sudah dihitung
    ];

    return view('admin.dashboard', compact(
        'page', 'stats', 'percentages', 'pendaftarTerbaru', 'rataRataUsia', 'infoSeleksi'
    ));
    }
}